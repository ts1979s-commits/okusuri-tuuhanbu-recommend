# 技術設計書 - お薬通販部商品レコメンドAI

## 🏗️ **システムアーキテクチャ**

### 全体構成図
```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   フロントエンド   │    │   バックエンド     │    │   データレイヤー   │
│   (Streamlit)  │ -> │   (Python)    │ -> │   (CSV)         │
│                 │    │               │    │                 │
│ - UI表示        │    │ - 検索処理    │    │ - 商品DB        │
│ - 入力受付      │    │ - データ変換  │    │                 │
│ - 結果表示      │    │ - ロジック    │    │                 │
└───────────────┘    └───────────────┘    └───────────────┘
```
> ※ FAISS/AIベクトル検索は現状未使用・拡張用サンプルです。

---

## 📁 **ファイル構成**

### プロジェクト構造
```
okusuri-tuuhanbu-recommend/
├── app.py                    # メインアプリケーション
├── requirements.txt          # Python依存関係
├── README.md                 # プロジェクト説明
├── docs/                     # ドキュメント
│   ├── プロジェクト仕様書.md
│   ├── 技術設計書.md
│   └── API設計書.md
├── data/                     # データファイル
│   ├── product_recommend.csv # 商品データベース
│   ├── documents.pkl         # FAISSドキュメント（オプション）
│   ├── faiss_index.bin       # FAISSインデックス（オプション）
│   ├── metadata.pkl          # FAISSメタデータ（オプション）
│   └── faiss_mapping.json    # FAISS設定（オプション）
└── env/                      # Python仮想環境
```

---

## 🔧 **コンポーネント設計**

### 1. メインアプリケーション (app.py)

#### 構成要素
```python
# グローバル変数
supplement_mapping = {...}  # サプリメント専用マッピング
data_path = 'data/product_recommend.csv'
products_df = None          # 商品データフレーム

# 主要関数
├── load_data()                # データロード
├── basic_search()             # 基本検索機能
├── category_search()          # カテゴリ検索
└── main()                     # Streamlitメイン処理
```

#### データフロー
```
1. アプリ起動 → load_data() → データロード
2. ユーザー入力 → 検索タイプ判定 → 検索実行
3. 結果取得 → 重複除去 → 表示処理
```

### 2. 検索エンジン設計

#### 検索処理フロー
```python
def basic_search(query, search_type):
    # 1. supplement_mappingチェック
    if query in supplement_mapping:
        category = supplement_mapping[query]
        # カテゴリ検索に変換
    # 2. 検索実行
    if search_type == "症状":
        results = products_df[products_df['効果'].str.contains(query, case=False, na=False)]
    elif search_type == "商品名":
        results = products_df[products_df['商品名'].str.contains(query, case=False, na=False)]
    elif search_type == "カテゴリ":
        results = products_df[products_df['カテゴリ'] == query]
    # 3. 重複除去
    results = results.drop_duplicates(subset=['商品名'])
    return results
```

#### 検索タイプ別処理
- 症状検索: 「効果」カラムで部分一致
- 商品名検索: 「商品名」カラムで部分一致
- カテゴリ検索: 「カテゴリ」カラムで完全一致

---

## 🗄️ **データベース設計**

### 商品テーブル (product_recommend.csv)
| カラム名 | データ型 | 制約 | 説明 |
|----------|----------|------|------|
| 商品名 | string | NOT NULL | 商品の正式名称 |
| 効果 | string | NULL | 商品の効果・効能 |
| 成分 | string | NULL | 主要成分 |
| カテゴリ | string | NOT NULL | 商品カテゴリ |
| 説明 | string | NULL | 商品の詳細説明 |
| URL | string | NULL | 商品ページのリンク |

---

## ⚡ **FAISS/AI検索システム設計（拡張用サンプル）**

- FAISS/AIベクトル検索は現状未使用・拡張用サンプルです。
- 利用時はapp.pyやrequirements.txtで有効化・パッケージ追加が必要です。

---

## 🎨 **UI設計**

### Streamlitレイアウト
- サイドバー: 検索タイプ選択、カテゴリ選択、設定オプション
- メインエリア: タイトル・説明、検索入力、検索結果表示
- 検索結果はカード形式で商品名・効果・成分・カテゴリ・リンクを表示

---

## 🔧 **設定管理**

### 環境設定
- .streamlit/config.tomlでテーマ・配色を管理
- 機能フラグ例:
```python
FEATURE_FLAGS = {
    'faiss_search': False,        # デフォルトは無効。必要時のみ有効化
    'cache_results': True,        # 検索結果キャッシュ
    'analytics': False,           # 分析機能
    'admin_panel': False          # 管理パネル
}
```

---

## 📊 **パフォーマンス設計**

- データロード・検索はpandas最適化、結果数制限で高速化
- メモリ・応答時間・キャッシュヒット率などを監視
- パフォーマンス指標例:
```python
performance_metrics = {
    'response_time': '< 100ms',     # 応答時間
    'memory_usage': '< 256MB',      # メモリ使用量
    'search_accuracy': '> 95%',     # 検索精度
    'cache_hit_rate': '> 80%'
}
```

---

## 🔒 **セキュリティ設計**

- 個人情報は扱わず、商品情報のみ
- 外部APIキーは必要時のみ設定・暗号化
- 入力検証で不正・危険な値を排除

---

## 🚀 **デプロイメント設計**

- GitHub Actions等でCI/CD自動化、Streamlit Cloudで自動デプロイ
- 開発→本番の環境分離

---

## 📈 **拡張設計**

- データソース拡張、AI/FAISS検索、UI/UX改善、スケーリング等は今後の拡張候補
- 本設計書の該当サンプルを参考に段階的に拡張可能