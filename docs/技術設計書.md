# 技術設計書 - 商品レコメンドLLMアプリ

## 🏗️ **システムアーキテクチャ**

### 全体構成図
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   フロントエンド    │    │   バックエンド      │    │   データレイヤー    │
│   (Streamlit)   │ -> │   (Python)     │ -> │   (CSV + FAISS) │
│                 │    │                 │    │                 │
│ - UI表示        │    │ - 検索処理      │    │ - 商品DB        │
│ - 入力受付      │    │ - データ変換    │    │ - ベクトル検索  │
│ - 結果表示      │    │ - ロジック実行  │    │ - キャッシュ    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📁 **ファイル構成**

### プロジェクト構造
```
okusuri-tuuhanbu-recommend/
├── app.py                    # メインアプリケーション
├── requirements.txt          # Python依存関係
├── README.md                 # プロジェクト説明
├── docs/                     # ドキュメント
│   ├── プロジェクト仕様書.md
│   ├── 技術設計書.md
│   └── API設計書.md
├── data/                     # データファイル
│   ├── product_recommend.csv # 商品データベース
│   ├── documents.pkl         # FAISSドキュメント
│   ├── faiss_index.bin       # FAISSインデックス
│   ├── metadata.pkl          # FAISSメタデータ
│   └── faiss_mapping.json    # FAISS設定
└── env/                      # Python仮想環境
```

## 🔧 **コンポーネント設計**

### 1. メインアプリケーション (app.py)

#### 構成要素
```python
# グローバル変数
supplement_mapping = {}  # サプリメント専用マッピング
products_df = None       # 商品データフレーム

# 主要関数
├── load_data()                # データロード
├── setup_rag_system()        # FAISS初期化
├── basic_search()             # 基本検索機能
├── category_search()          # カテゴリ検索
└── main()                     # Streamlitメイン処理
```

#### データフロー
```
1. アプリ起動 → load_data() → データロード
2. ユーザー入力 → 検索タイプ判定 → 検索実行
3. 結果取得 → 重複除去 → 表示処理
```

### 2. 検索エンジン設計

#### 検索処理フロー
```python
def basic_search(query, search_type):
    # 1. supplement_mappingチェック
    if query in supplement_mapping:
        category = supplement_mapping[query]
        # カテゴリ検索に変換
    
    # 2. 検索実行
    if search_type == "症状":
        results = products_df[products_df['効果'].str.contains(query, case=False, na=False)]
    elif search_type == "商品名":
        results = products_df[products_df['商品名'].str.contains(query, case=False, na=False)]
    
    # 3. 重複除去
    results = results.drop_duplicates(subset=['商品名'])
    
    return results
```

#### 検索タイプ別処理

**症状検索**
```python
# 対象フィールド: 効果
# 処理: 部分一致検索（大文字小文字無視）
# 例: "頭痛" → 効果に"頭痛"を含む商品
```

**商品名検索**
```python
# 対象フィールド: 商品名
# 処理: 部分一致検索（大文字小文字無視）
# 例: "スペ" → 商品名に"スペ"を含む商品
```

**カテゴリ検索**
```python
# 対象フィールド: カテゴリ
# 処理: 完全一致検索
# 例: "男性向けサプリ" → カテゴリが"男性向けサプリ"の商品
```

## 🗄️ **データベース設計**

### 商品テーブル (product_recommend.csv)

| カラム名 | データ型 | 制約 | インデックス | 説明 |
|----------|----------|------|--------------|------|
| 商品名 | VARCHAR(100) | NOT NULL | PRIMARY | 商品の一意識別子 |
| 効果 | TEXT | NULL | INDEX | 検索対象フィールド |
| 成分 | TEXT | NULL | - | 商品成分情報 |
| カテゴリ | VARCHAR(50) | NOT NULL | INDEX | カテゴリ分類 |
| 説明 | TEXT | NULL | - | 詳細説明 |
| URL | TEXT | NULL | - | 商品ページリンク |

### データ整合性
```python
# 必須フィールドチェック
required_fields = ['商品名', 'カテゴリ']

# カテゴリ値検証
valid_categories = [
    '解熱鎮痛薬', '風邪薬', '胃腸薬', '外用薬', '目薬', 
    '鼻炎薬', 'のど薬', '男性向けサプリ', '女性向けサプリ', 
    '美容・健康サプリ', 'ビタミン・ミネラル'
]
```

## ⚡ **FAISS検索システム設計**

### アーキテクチャ
```python
class FAISSRAGSystem:
    def __init__(self):
        self.index = None           # FAISSインデックス
        self.documents = []         # 元文書
        self.metadata = []          # メタデータ
        self.embeddings_model = OpenAIEmbeddings()
    
    def build_index(self, documents):
        # 1. テキスト埋め込み生成
        # 2. FAISSインデックス構築
        # 3. キャッシュ保存
    
    def search(self, query, k=5):
        # 1. クエリ埋め込み生成
        # 2. 類似度検索実行
        # 3. 結果返却
```

### 埋め込みベクトル設計
```python
# 埋め込み対象テキスト構成
document_text = f"""
商品名: {row['商品名']}
効果: {row['効果']}
成分: {row['成分']}
カテゴリ: {row['カテゴリ']}
説明: {row['説明']}
"""
```

### キャッシュ戦略
```python
# ファイルベースキャッシュ
cache_files = {
    'index': 'data/faiss_index.bin',
    'documents': 'data/documents.pkl',
    'metadata': 'data/metadata.pkl',
    'mapping': 'data/faiss_mapping.json'
}
```

## 🎨 **UI設計**

### Streamlitレイアウト
```python
# ページ構成
st.set_page_config(
    page_title="お薬通販部 - 商品レコメンド",
    page_icon="💊",
    layout="wide"
)

# サイドバー
with st.sidebar:
    # 検索タイプ選択
    # カテゴリ選択（カテゴリ検索時）
    # 設定オプション

# メインエリア
# タイトル・説明
# 検索入力フィールド
# 検索結果表示
```

### 検索結果表示設計
```python
# 結果カード形式
for product in results:
    with st.container():
        col1, col2 = st.columns([3, 1])
        with col1:
            st.subheader(product['商品名'])
            st.write(f"**効果:** {product['効果']}")
            st.write(f"**成分:** {product['成分']}")
            st.write(f"**カテゴリ:** {product['カテゴリ']}")
        with col2:
            st.link_button("商品ページ", product['URL'])
```

## 🔧 **設定管理**

### 環境設定
```python
# Streamlit設定 (.streamlit/config.toml)
[theme]
primaryColor = "#FF6B6B"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F0F0F0"

# 実行時設定
DEBUG_MODE = False
USE_FAISS = True
OPENAI_API_KEY = "設定時に指定"
```

### 機能フラグ
```python
FEATURE_FLAGS = {
    'faiss_search': True,        # FAISS検索有効化
    'cache_results': True,       # 検索結果キャッシュ
    'analytics': False,          # 分析機能
    'admin_panel': False         # 管理パネル
}
```

## 📊 **パフォーマンス設計**

### 最適化戦略
1. **データロード最適化**
   - CSV読み込みキャッシュ
   - pandas最適化設定

2. **検索パフォーマンス**
   - インデックス活用
   - 結果数制限

3. **メモリ管理**
   - ストリーミング処理
   - 不要データ削除

### 監視指標
```python
performance_metrics = {
    'response_time': '< 100ms',     # 応答時間
    'memory_usage': '< 256MB',      # メモリ使用量
    'search_accuracy': '> 95%',     # 検索精度
    'cache_hit_rate': '> 80%'       # キャッシュヒット率
}
```

## 🔒 **セキュリティ設計**

### データ保護
- 個人情報なし
- 商品情報のみ
- 外部APIキー暗号化

### 入力検証
```python
def validate_input(query):
    # 1. 文字列長制限
    if len(query) > 100:
        return False
    
    # 2. 特殊文字フィルタ
    if re.search(r'[<>"\']', query):
        return False
    
    return True
```

## 🚀 **デプロイメント設計**

### CI/CD パイプライン
```yaml
# GitHub Actions (概念)
1. コード変更検出
2. 自動テスト実行
3. Streamlit Cloud自動デプロイ
4. ヘルスチェック
```

### 環境構成
```
Development → Staging → Production
    ↓           ↓          ↓
  ローカル   →  テスト   → Streamlit Cloud
```

## 📈 **拡張設計**

### 将来拡張ポイント
1. **データソース拡張**
   - API連携
   - リアルタイム更新
   - 外部データベース

2. **検索機能強化**
   - 自然言語処理
   - 機械学習推薦
   - ユーザー行動分析

3. **UI/UX改善**
   - モバイル対応
   - 多言語対応
   - アクセシビリティ

### スケーリング戦略
```python
scaling_options = {
    'horizontal': 'マルチインスタンス',
    'vertical': 'リソース増強',
    'caching': 'Redis導入',
    'cdn': 'コンテンツ配信最適化'
}
```